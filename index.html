<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Network Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark light;
      --bg: #05060a;
      --fg: #f6f7fb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --danger: #ef4444;
      --ok: #10b981;
      --card: #111827;
      --border: #1f2933;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 1.5rem;
      font-family: var(--sans);
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--fg);
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 0.25rem;
    }

    h2 {
      font-size: 1.1rem;
      margin: 0 0 0.5rem;
    }

    .tagline {
      margin: 0 0 1.25rem;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .card {
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, #020617, #020617 40%, #030712 100%);
      padding: 1rem 1.1rem;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.8);
    }

    .muted { color: var(--muted); }

    .mono { font-family: var(--mono); }

    .hidden { display: none; }

    .unlock-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .unlock-input {
      flex: 1 1 180px;
      min-width: 0;
      padding: 0.4rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--fg);
      font-family: var(--mono);
      font-size: 0.8rem;
    }

    .unlock-input::placeholder {
      color: var(--muted);
      opacity: 0.8;
    }

    .pill {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(15, 23, 42, 0.7);
      margin-bottom: 0.75rem;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--danger);
    }

    .pill-dot.ok { background: var(--ok); }
    .pill-dot.warn { background: #eab308; }

    .status-line {
      display: flex;
      gap: 0.75rem;
      align-items: baseline;
      margin-bottom: 0.2rem;
      font-size: 0.9rem;
    }

    .status-label {
      width: 7rem;
      color: var(--muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status-value {
      font-family: var(--mono);
      font-size: 0.9rem;
    }

    .status-value.ok { color: var(--ok); }
    .status-value.warn { color: #eab308; }
    .status-value.bad { color: var(--danger); }

    .status-age-ok { color: var(--muted); }
    .status-age-warn { color: #eab308; }
    .status-age-stale { color: var(--danger); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    th, td {
      padding: 0.45rem 0.35rem;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    th {
      color: var(--muted);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .chip {
      border-radius: 999px;
      padding: 0.12rem 0.6rem;
      font-size: 0.72rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--danger);
    }

    .chip-dot.ok { background: var(--ok); }
    .chip-dot.warn { background: #eab308; }

    .host-chips-mobile {
      display: none;
      margin-top: 0.35rem;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .host-status-desktop,
    .host-http-desktop {
      white-space: nowrap;
    }

    .footer {
      margin-top: 1.25rem;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .forget-link {
      display: inline-block;
      margin-top: 0.35rem;
      font-size: 0.75rem;
      color: var(--muted);
      text-decoration: underline;
      cursor: pointer;
    }

    .error {
      color: var(--danger);
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    button {
      font-family: inherit;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 0.25rem 0.7rem;
      background: transparent;
      color: var(--fg);
      cursor: pointer;
    }

    button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    @media (max-width: 720px) {
      body { padding: 1rem; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Network Status</h1>
    </header>

    <section class="card" id="unlock-card">
      <h2>Unlock</h2>
      <div class="unlock-row">
        <input
          id="passphrase-input"
          class="unlock-input"
          type="password"
          spellcheck="false"
          autocomplete="off"
        />
        <button id="btn-unlock">Unlock</button>
      </div>
      <div style="margin-top:0.5rem; font-size:0.8rem; display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
        <span class="muted">Stored key: <span id="status-key" class="status-value warn">not stored</span></span>
        <button id="btn-forget">Forget key</button>
        <span class="muted">Key stays in this browser only.</span>
      </div>
      <div class="error" id="error"></div>
    </section>

    <div id="main-content" class="hidden" style="margin-top:1rem;">
      <section class="card">
        <div class="pill" id="pill-status">
          <span class="pill-dot" id="pill-dot"></span>
          <span id="pill-text">Waiting for decryption</span>
        </div>

        <div class="status-line">
          <div class="status-label">Snapshot</div>
          <div class="status-value" id="status-generated">-</div>
        </div>
        <div class="status-line">
          <div class="status-label">Hosts</div>
          <div class="status-value" id="status-hosts">-</div>
        </div>
      </section>

      <section class="card" style="margin-top:1rem;">
        <h2>Hosts</h2>
        <div id="hosts-table-wrapper" class="muted" style="font-size:0.85rem;">Encrypted payload not yet unlocked.</div>
      </section>

      <footer class="footer">
        <div>Data is encrypted end-to-end with a passphrase-derived key; the passphrase never leaves your browser.</div>
        <a href="#" id="link-forget" class="forget-link">Forget key on this device</a>
      </footer>
    </div>

    <script id="encrypted-data" type="application/json">{"v":1,"algo":"AES-GCM","kdf":"PBKDF2","iterations":200000,"salt":"hfgsLZMInf2X9ktl9tqXBA==","iv":"CAyGkCAqumuouc5b","data":"bHUM6QD+KAgoZYjSjJ5UUPVwClwO4PZSmh3B2b8blKTSOhrJ8vUkKszAUEn1kl5uftInECSXLACi2IHeIAlhq58Ce5OZ7HBvOU8Qz/UZBP/WEGson+PCNgSvt8YLVpY5ScQgUx+gxEUc1QxG86JWCIP03OgPUQZ/ZrWPj2i4GC4N6lQ6JvxI9Pb1ERKEhJ9EKKBBQA3wvnGCZyXc7dGEGxGoRzyV4c3WPSh9JlkhwoVxiRuVn08W8+fOqCUsjLque5U7dMl01kwrYfG1tLgtaiY5Qf5Qz78Vf3p8XAU3cyHrjuq46CsB6cupEZuwDoGVSY/mNrewBsJYz1cx3LRRWAdqdsHJY29/+9yDfnaDz44vDsjQ6ZWE15Cn0SbEGKZRvAAlT8v+fcmYSPQx4N3d4XcB/dwfte2L2YBesf8oX2nqcA/t1CU+1AQRdJDCZOGiCqhpKBtC4k23RKwGmzhB4LR0cEqoplfRmsvxdl7r0dRREZc1Rrq7MdKLeAcL7PNB+PjMLcmcmU1MCRp3PIdODTDNUijFZwJJd59aQhZXs7YrFmU/LvOniaBiEKHLoBHvGsQD7Y0gryBjh26bQpnbvl4yP1oTJSS2bZCZcEL2OzEqIhBu4MEsKgly9KHKQ6FNd3DjdZhUtUe5zX9192qRKHHsXpWKQSefDT+opwMF9K8Tw/R97f5EOO5u5aGQf/MjtLqr1RV8xTUAGfegZbMAchiU2WwbEFr8f671R2iwjBZNRMt9puWRjczhKqyBUBovEWpz8eif7blWH0wAKeYKFbhXNMcB8bjT+O5Z0RBGv4byV7Xss+q3FaDu/41yXfnXSd0mffBpQWILwjyR54pui6Iv8uhrcnOOMTKxMgXPMLY1KpA42ItovM1rL6dPTyp0UVkq47i/dlEhjZj8Q0PhLiBnF323Gt80JU3sUGUB60vF8FesGZvhAHdaDTsBN2JZ0SxjT+OgA5x+WjhFWJ1evLQmRYoLcXz5ct6hak5dknKKIHtrxooqC3PP8TflWDnzleBaoI8QWHvhyEMGCjFuufHimYSS/XvcnTDW0uBMu/wWzbBushbirn1cZvmjP1j8PYdN1nOXj8GKgZOZnG9pHc7JWo4IuK4Qsgmrv/JPWq9LrmzR7BUVjOv1AM3EKuVvTP9KTGJIuVV+5Yh5Acq9RMHixRuMOditrGeiLxCsqD/7/K4j+HhQrix6XQ1TMZXOj+9a5i9avLonAmJbIu6p89i43spXt8f7TfSJ7Uex345nrhbHxZAhK7wNx/qtABLLpZjB3kmjtWZ5Q7zlzjnnHMFOmRhxdNG7mSUpdpk08+0NRG3kGlKaBynCTRnyatLtRfH6wgdmGjPga9hHWzX4qIYCK2A2iP50M9ajALkvw3hoqCUTBgYxel9HqvVykhX4H3rqcYg0d2214GFyoVMJGTRn4C15mYfzYRvGW03J7kNWxVIrQozHdw=="}</script>

    <script>
      const STORAGE_KEY = 'networkStatus.passphrase';

      function base64ToBytes(b64) {
        const bin = atob(b64);
        const len = bin.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
        return bytes;
      }

      function bytesToString(bytes) {
        return new TextDecoder().decode(bytes);
      }

      async function deriveKey(passphrase, salt, iterations) {
        const enc = new TextEncoder();
        const baseKey = await crypto.subtle.importKey(
          'raw',
          enc.encode(passphrase),
          { name: 'PBKDF2' },
          false,
          ['deriveKey']
        );

        return crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt,
            iterations,
            hash: 'SHA-256',
          },
          baseKey,
          { name: 'AES-GCM', length: 256 },
          false,
          ['decrypt']
        );
      }

      async function decryptPayload(payload, passphrase) {
        const salt = base64ToBytes(payload.salt);
        const iv = base64ToBytes(payload.iv);
        const data = base64ToBytes(payload.data);

        const key = await deriveKey(passphrase, salt, payload.iterations);

        const plaintextBytes = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv },
          key,
          data
        );

        return bytesToString(new Uint8Array(plaintextBytes));
      }

      function formatDate(iso) {
        if (!iso) return '-';
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso;
        return d.toLocaleString(undefined, { hour12: false });
      }

      function formatAge(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return '';
        const diffMs = Date.now() - d.getTime();
        if (diffMs < 0) return '0s ago';
        const seconds = Math.floor(diffMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        if (hours >= 1) return `${hours}h ${minutes % 60}m ago`;
        if (minutes >= 1) return `${minutes}m ${seconds % 60}s ago`;
        return `${seconds}s ago`;
      }

      function updateSummary(data) {
        const pillDot = document.getElementById('pill-dot');
        const pillText = document.getElementById('pill-text');
        const generatedEl = document.getElementById('status-generated');
        const hostsEl = document.getElementById('status-hosts');

        const total = data.hosts?.length || 0;
        const up = data.hosts?.filter(h => h.up).length || 0;

        const when = formatDate(data.generatedAt);
        const age = formatAge(data.generatedAt);
        generatedEl.textContent = age ? `${when} (${age})` : when;
        generatedEl.classList.remove('status-age-ok', 'status-age-warn', 'status-age-stale');

        const d = new Date(data.generatedAt);
        let ageClass = 'status-age-ok';
        if (!Number.isNaN(d.getTime())) {
          const diffMs = Date.now() - d.getTime();
          const minutes = diffMs / 60000;
          if (minutes >= 15) ageClass = 'status-age-stale';
          else if (minutes >= 5) ageClass = 'status-age-warn';
        }
        generatedEl.classList.add(ageClass);

        hostsEl.textContent = `${up}/${total} up`;

        pillDot.classList.remove('ok', 'warn');

        if (total === 0) {
          pillText.textContent = 'No hosts in snapshot';
        } else if (up === total) {
          pillDot.classList.add('ok');
          pillText.textContent = 'All hosts reachable';
        } else if (up === 0) {
          pillText.textContent = 'All hosts reported down';
        } else {
          pillDot.classList.add('warn');
          pillText.textContent = 'Partial outage';
        }
      }

      function renderHostsTable(data) {
        const wrapper = document.getElementById('hosts-table-wrapper');
        const hostsRaw = data.hosts || [];

        const hosts = hostsRaw.slice().sort((a, b) => {
          const aOffline = !a.up || a.httpOk === false;
          const bOffline = !b.up || b.httpOk === false;
          if (aOffline !== bOffline) return aOffline ? -1 : 1;
          const aName = (a.name || '').toLowerCase();
          const bName = (b.name || '').toLowerCase();
          if (aName < bName) return -1;
          if (aName > bName) return 1;
          return 0;
        });

        if (!hosts.length) {
          wrapper.textContent = 'No host data in snapshot.';
          return;
        }

        const rows = hosts.map(h => {
          const latencyValue = h.latencyMs != null ? `${h.latencyMs} ms` : null;
          const latency = latencyValue || 'n/a';
          const isOffline = !h.up || h.httpOk === false;
          const statusDotClass = isOffline ? '' : 'ok';
          const statusLabel = isOffline ? 'down' : (latencyValue ? `up Â· ${latencyValue}` : 'up');
          const rawName = h.name || '';
          let displayName = rawName;
          if (displayName.endsWith('blecher.at')) {
            displayName = displayName.replace(/\.?blecher\.at$/, '');
          }
          const ip = h.ip || rawName || '';
          const httpStatus = typeof h.httpStatus === 'number' ? h.httpStatus : null;

          let httpDotClass = '';
          if (httpStatus !== null) {
            if (httpStatus >= 200 && httpStatus < 300) httpDotClass = 'ok';
            else if (httpStatus >= 300 && httpStatus < 400) httpDotClass = 'warn';
          }

          const statusChip = `
            <span class="chip">
              <span class="chip-dot ${statusDotClass}"></span>
              <span>${statusLabel}</span>
            </span>
          `;

          const httpChip = httpStatus !== null
            ? `<span class="chip">
                 <span class="chip-dot ${httpDotClass}"></span>
                 <span>${httpStatus}</span>
               </span>`
            : '';

          return `
            <tr>
              <td>
                <div class="mono">${displayName}</div>
                <div class="muted" style="font-size:0.7rem;">${ip}</div>
                <div class="host-chips-mobile">
                  ${statusChip}
                  ${httpChip}
                </div>
              </td>
              <td class="host-status-desktop">${statusChip}</td>
              <td class="host-http-desktop">${httpChip}</td>
            </tr>
          `;
        }).join('');

        wrapper.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Host</th>
                <th>Status</th>
                <th>HTTP</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      }

      function getStoredPassphrase() {
        try {
          return localStorage.getItem(STORAGE_KEY) || '';
        } catch {
          return '';
        }
      }

      function setStoredPassphrase(value) {
        try {
          if (value) localStorage.setItem(STORAGE_KEY, value);
          else localStorage.removeItem(STORAGE_KEY);
        } catch {
          // ignore
        }
      }

      function updateKeyStatus() {
        const el = document.getElementById('status-key');
        const value = getStoredPassphrase();
        if (!el) return;
        if (!value) {
          el.textContent = 'not stored';
          el.className = 'status-value warn';
        } else {
          const words = value.trim().split(/[-\s]+/g);
          el.textContent = `${words.length} words stored`;
          el.className = 'status-value ok';
        }
      }

      async function unlock(options = {}) {
        const { auto = false } = options;
        const errorEl = document.getElementById('error');
        if (errorEl) errorEl.textContent = '';

        const scriptEl = document.getElementById('encrypted-data');
        const raw = scriptEl ? scriptEl.textContent.trim() : '';

        if (!raw || raw === '__ENCRYPTED_JSON__') {
          if (!auto && errorEl) {
            errorEl.textContent = 'No encrypted payload embedded (cron job may not have run yet).';
          }
          return;
        }

        let payload;
        try {
          payload = JSON.parse(raw);
        } catch (e) {
          if (!auto && errorEl) errorEl.textContent = 'Failed to parse encrypted payload.';
          return;
        }

        const inputEl = document.getElementById('passphrase-input');
        const inputValue = inputEl ? inputEl.value.trim() : '';

        let passphrase = getStoredPassphrase();
        if (inputValue) {
          passphrase = inputValue;
          setStoredPassphrase(passphrase);
          inputEl.value = '';
        }

        if (!passphrase) {
          if (!auto && errorEl) {
            errorEl.textContent = 'Passphrase is required to decrypt.';
          }
          return;
        }

        updateKeyStatus();

        try {
          const plaintext = await decryptPayload(payload, passphrase);
          const data = JSON.parse(plaintext);
          updateSummary(data);
          renderHostsTable(data);

          const main = document.getElementById('main-content');
          const unlockCard = document.getElementById('unlock-card');
          if (main) main.classList.remove('hidden');
          if (unlockCard) unlockCard.classList.add('hidden');
        } catch (e) {
          console.error(e);
          setStoredPassphrase('');
          updateKeyStatus();
          if (!auto && errorEl) {
            errorEl.textContent = 'Decryption failed. Check your passphrase (3-word key).';
          }
        }
      }

      document.getElementById('btn-unlock').addEventListener('click', () => {
        unlock({ auto: false });
      });

      document.getElementById('btn-forget').addEventListener('click', () => {
        setStoredPassphrase('');
        updateKeyStatus();
        const main = document.getElementById('main-content');
        if (main) main.classList.add('hidden');
        const unlockCard = document.getElementById('unlock-card');
        if (unlockCard) unlockCard.classList.remove('hidden');
        const errorEl = document.getElementById('error');
        if (errorEl) errorEl.textContent = 'Stored key cleared. Enter it again to unlock.';
      });

      const forgetLink = document.getElementById('link-forget');
      if (forgetLink) {
        forgetLink.addEventListener('click', (e) => {
          e.preventDefault();
          setStoredPassphrase('');
          updateKeyStatus();
          const main = document.getElementById('main-content');
          if (main) main.classList.add('hidden');
          const unlockCard = document.getElementById('unlock-card');
          if (unlockCard) unlockCard.classList.remove('hidden');
        });
      }

      updateKeyStatus();

      if (getStoredPassphrase()) {
        unlock({ auto: true }).catch(() => {});
      }
    </script>
  </div>
</body>
</html>
